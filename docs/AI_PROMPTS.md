# AI “Настрой дня”: промпты и мок-генерация

Этот документ описывает, как устроена vibe-фича “AI Настрой дня”: выбор настроения → генерация короткой аффирмации/мини-медитации.

Цель — показать **prompt engineering** и при этом оставить прототип стабильным:
- без ключей и сети (мок по умолчанию),
- с возможностью быстро подключить реальный LLM позже.

---

## Требования к результату

Результат генерации должен быть:
- на русском языке (или на языке UI, если добавится локализация);
- коротким: **1–3 предложения** (или 40–80 слов, если нужна жёсткая метрика);
- в спокойном, поддерживающем тоне;
- без медицинских утверждений и “лечебных обещаний”;
- без упоминаний “как AI/модель” — текст должен звучать естественно.

---

## Модель настроения (3 варианта)

Настроение кодируется как enum/union и **не должно зависеть от того, как оно нарисовано в UI** (иконка/цвет).

Пример:
- `calm`
- `neutral`
- `stressed`

В UI можно отрисовать эти варианты любыми иконками (например, смайлами), но в доменной логике используются только коды.

---

## Структура модуля (предлагаемая)

```text
src/services/ai/
  ai.service.ts     // оркестрация (mock/real, задержка, ошибки, fallback)
  prompts.ts        // чистые функции сборки промптов
  ai.types.ts       // типы Mood, AiResult, AiProvider
```

Разделение нужно, чтобы:
- `prompts.ts` тестировался unit-тестами (без React/сетей);
- `ai.service.ts` можно было переключать между мок и реальным провайдером.

---

## Базовый промпт (шаблон)

Идея: сделать промпт максимально конкретным, чтобы UI не ломался от слишком длинного текста и чтобы тон был стабильным.

### System (если провайдер поддерживает)

```text
Ты — спокойный и лаконичный наставник по медитации. Пиши коротко, мягко и без медицинских обещаний.
```

### User (шаблон)

```text
Сгенерируй короткую аффирмацию или мини-медитацию для пользователя.

Настроение: {MOOD_LABEL}
Ограничения:
- 1–3 предложения
- нейтрально‑поддерживающий тон
- без слов “диагноз”, “вылечит”, “гарантировано”

Формат: только текст, без списков и заголовков.
```

Где `{MOOD_LABEL}` — человекочитаемое описание:
- `calm` → “спокойное”
- `neutral` → “нейтральное”
- `stressed` → “напряжённое”

---

## Варианты “усиления” промпта (если модель уходит в длину)

Если модель часто выдаёт слишком длинный текст:

1) Ужесточить лимит:
```text
Ровно 2 предложения. Не больше 40 слов.
```

2) Добавить негативные примеры:
```text
Не делай: длинные абзацы, списки, инструкции на 10 шагов.
```

3) Добавить “контракт” формата:
```text
Если не можешь уложиться — сократи, но не добавляй четвёртое предложение.
```

---

## Мок-генерация (по умолчанию)

Причины:
- сеть может быть недоступна на проверке;
- нельзя хранить ключи в репозитории;
- мок проще демонстрировать на видео без риска ошибок.

### Рекомендованное поведение мока

- `await delay(600..1200ms)` — чтобы UX был похож на реальный запрос.
- Возвращать 3–6 заранее подготовленных вариантов на каждое настроение.
- (Опционально) лёгкая рандомизация, но без “скачков” качества:
  - случайный выбор из набора;
  - или выбор по `(dayOfYear % variants.length)` для “стабильного дня”.

### Fallback

Если реальный провайдер включён, но:
- нет сети,
- нет ключа,
- запрос упал,

то возвращать мок/локальный текст, а UI показывает ненавязчивое состояние (например, “offline mode” внизу).

---

## Что логировать (для дебага, не для продакшна)

В dev-режиме полезно логировать:
- выбранное настроение,
- какой провайдер использован (mock/real),
- время выполнения.

Важно: не логировать секреты/ключи и не сохранять промпт с персональными данными пользователя (в прототипе данных нет — так и оставить).

---

## Unit-тесты для AI (предлагаемый минимум)

1) `prompts.ts`:
- промпт содержит mood-лейбл;
- промпт содержит явные ограничения (1–3 предложения);
- промпт содержит запрет на медицинские обещания.

2) `ai.service.ts` (опционально):
- при ошибке провайдера возвращается fallback;
- задержка (если нужна) контролируется через `jest.useFakeTimers()`.

